# æœ€æ–°é—®é¢˜ä¿®å¤ï¼šå›¾åƒå°ºå¯¸å…¼å®¹æ€§

## ğŸ”´ é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
AssertionError: Input image height 256 is not a multiple of patch height 14
```

### å‘ç”Ÿä½ç½®
`models/backbones/nets/dino_v2_with_adapter/dino_v2/layers/patch_embed.py` ç¬¬ 72 è¡Œ

### æ ¹æœ¬åŸå› 
DINOv2 ä½¿ç”¨ patch_size=14 çš„ patch embeddingï¼Œè¦æ±‚è¾“å…¥å›¾åƒçš„é«˜åº¦å’Œå®½åº¦å¿…é¡»æ˜¯ 14 çš„æ•´æ•°å€ã€‚

RaCFormer é»˜è®¤é…ç½®ä½¿ç”¨çš„å›¾åƒå°ºå¯¸æ˜¯ `(256, 704)`ï¼š
- **256 Ã· 14 = 18.28...** âŒ ä¸èƒ½æ•´é™¤
- **704 Ã· 14 = 50.28...** âŒ ä¸èƒ½æ•´é™¤

è¿™å¯¼è‡´ DINOv2 adapter æ— æ³•å¤„ç† RaCFormer çš„é»˜è®¤å›¾åƒå°ºå¯¸ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šè‡ªåŠ¨ Padding

åœ¨ `dinov2_adapter.py` çš„ `forward` æ–¹æ³•ä¸­æ·»åŠ è‡ªåŠ¨ padding é€»è¾‘ï¼š

1. **è¾“å…¥æ—¶æ·»åŠ  padding**ï¼šå°†å›¾åƒ padding åˆ° patch_size çš„æ•´æ•°å€
2. **å¤„ç†**ï¼šDINOv2 å¤„ç† padding åçš„å›¾åƒ
3. **è¾“å‡ºæ—¶è£å‰ª**ï¼šå°†è¾“å‡ºè£å‰ªå›åŸå§‹å°ºå¯¸å¯¹åº”çš„ç‰¹å¾å›¾å¤§å°

### ä¿®æ”¹æ–‡ä»¶
`models/backbones/nets/dino_v2_with_adapter/dino_v2_adapter/dinov2_adapter.py`

### ä¿®æ”¹å†…å®¹

#### 1. æ·»åŠ  padding é€»è¾‘ï¼ˆforward æ–¹æ³•å¼€å§‹ï¼‰

```python
def forward(self, x):
    deform_inputs1, deform_inputs2 = deform_inputs(x)

    # SPM forward
    c1, c2, c3, c4 = self.spm(x)
    c2, c3, c4 = self._add_level_embed(c2, c3, c4)
    c = torch.cat([c2, c3, c4], dim=1)

    # Patch Embedding forward
    # æ·»åŠ è‡ªåŠ¨paddingä»¥ç¡®ä¿å°ºå¯¸æ˜¯patch_sizeçš„æ•´æ•°å€
    _, _, h, w = x.shape
    pad_h = (self.patch_size - h % self.patch_size) % self.patch_size
    pad_w = (self.patch_size - w % self.patch_size) % self.patch_size
    
    if pad_h > 0 or pad_w > 0:
        x_padded = torch.nn.functional.pad(x, (0, pad_w, 0, pad_h), mode='constant', value=0)
    else:
        x_padded = x
    
    x_patched = self.patch_embed(x_padded)
    # ä½¿ç”¨paddingåçš„å°ºå¯¸è®¡ç®—
    h_padded = h + pad_h
    w_padded = w + pad_w
    W_vit = w_padded // self.patch_size
    H_vit = h_padded // self.patch_size
    W_adapt = w // 16
    H_adapt = h // 16
```

#### 2. ä½¿ç”¨ patched ç‰¹å¾ï¼ˆåç»­å¤„ç†ï¼‰

```python
    bs, n, dim = x_patched.shape
    pos_embed = self._get_pos_embed(self.pos_embed[:, 1:], H_vit, W_vit)
    x = x_patched + pos_embed
    cls = self.cls_token.expand(x.shape[0], -1, -1) + self.pos_embed[:, 0]
```

#### 3. è¾“å‡ºæ—¶è£å‰ªï¼ˆforward æ–¹æ³•ç»“å°¾ï¼‰

```python
    # Final Norm
    f1 = self.norm1(c1)
    f2 = self.norm2(c2)
    f3 = self.norm3(c3)
    f4 = self.norm4(c4)
    
    # å¦‚æœæœ‰paddingï¼Œè£å‰ªå›åŸå§‹å°ºå¯¸
    # f1, f2, f3, f4 çš„ç›®æ ‡å°ºå¯¸åˆ†åˆ«æ˜¯åŸå§‹å›¾åƒçš„ 1x, 1/2x, 1/4x, 1/8x
    # ç”±äºå®ƒä»¬æ˜¯åŸºäºSPMå¤„ç†çš„åŸå§‹xï¼ˆæœªpaddingï¼‰ï¼Œæ‰€ä»¥ä¸éœ€è¦è£å‰ª
    # ä½†æ˜¯ x_out æ˜¯åŸºäº padding åçš„ç»“æœï¼Œéœ€è¦è£å‰ª
    if pad_h > 0 or pad_w > 0:
        # x_out å°ºå¯¸æ˜¯ [bs, dim, H_vit, W_vit]ï¼Œéœ€è¦è£å‰ªåˆ° [bs, dim, h//patch_size, w//patch_size]
        target_h = h // self.patch_size
        target_w = w // self.patch_size
        x_out = x_out[:, :, :target_h, :target_w]
    
    return [f1, f2, f3, f4], x_out
```

---

## ğŸ§ª éªŒè¯ä¿®å¤

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
python test_dinov2_patch_size.py
```

è¯¥è„šæœ¬ä¼šæµ‹è¯•ï¼š
1. å„ç§å›¾åƒå°ºå¯¸çš„å…¼å®¹æ€§ï¼ˆåŒ…æ‹¬ RaCFormer é»˜è®¤çš„ 256x704ï¼‰
2. RaCFormer + DINOv2 é…ç½®å…¼å®¹æ€§

### é¢„æœŸè¾“å‡º

```
======================================================================
  DINOv2 Adapter å›¾åƒå°ºå¯¸å…¼å®¹æ€§æµ‹è¯•
======================================================================

æµ‹è¯•ç”¨ä¾‹:
----------------------------------------------------------------------
âœ… RaCFormeré»˜è®¤           | è¾“å…¥:  256x 704 | è¾“å‡ºç‰¹å¾: 4å±‚ | f1: (256, 704)
âœ… å®Œç¾æ•´é™¤                | è¾“å…¥:  224x 224 | è¾“å‡ºç‰¹å¾: 4å±‚ | f1: (224, 224)
âœ… NuScenesåŸå§‹            | è¾“å…¥:  900x1600 | è¾“å‡ºç‰¹å¾: 4å±‚ | f1: (900, 1600)
âœ… éšæœºå°ºå¯¸1               | è¾“å…¥:  480x 640 | è¾“å‡ºç‰¹å¾: 4å±‚ | f1: (480, 640)
âœ… éšæœºå°ºå¯¸2               | è¾“å…¥:  300x 500 | è¾“å‡ºç‰¹å¾: 4å±‚ | f1: (300, 500)
----------------------------------------------------------------------

âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼DINOv2 Adapter å¯ä»¥å¤„ç†ä»»æ„å°ºå¯¸å›¾åƒ
======================================================================
```

### æ‰‹åŠ¨éªŒè¯

```bash
python -c "
import torch
from models.backbones import DinoAdapter

adapter = DinoAdapter(num_heads=6, embed_dim=384, depth=12, pretrained_vit=False)
img = torch.randn(2, 3, 256, 704)
feats, x_out = adapter(img)
print(f'âœ… 256x704 å›¾åƒå¤„ç†æˆåŠŸï¼')
print(f'   è¾“å‡ºç‰¹å¾: {len(feats)} å±‚')
for i, f in enumerate(feats):
    print(f'   f{i+1}: {f.shape}')
"
```

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### Padding ç­–ç•¥

```python
# è®¡ç®—éœ€è¦çš„ padding
pad_h = (patch_size - height % patch_size) % patch_size
pad_w = (patch_size - width % patch_size) % patch_size

# ç¤ºä¾‹ï¼š256x704 with patch_size=14
# pad_h = (14 - 256 % 14) % 14 = (14 - 4) % 14 = 10
# pad_w = (14 - 704 % 14) % 14 = (14 - 4) % 14 = 10
# 
# paddingå: 266x714
# 266 / 14 = 19 âœ…
# 714 / 14 = 51 âœ…
```

### ç‰¹å¾å°ºå¯¸å¯¹åº”å…³ç³»

| ç‰¹å¾å±‚ | ç›¸å¯¹å°ºå¯¸ | 256x704 è¾“å…¥ | è¯´æ˜ |
|--------|---------|-------------|------|
| f1 | 1x | 256x704 | ä¸è¾“å…¥åŒå°ºå¯¸ |
| f2 | 1/2x | 128x352 | ä¸‹é‡‡æ · 2 å€ |
| f3 | 1/4x | 64x176 | ä¸‹é‡‡æ · 4 å€ |
| f4 | 1/8x | 32x88 | ä¸‹é‡‡æ · 8 å€ |

### æ€§èƒ½å½±å“

- **è®¡ç®—å¼€é”€**ï¼špadding å¢åŠ çš„è®¡ç®—é‡å¾ˆå°ï¼ˆé€šå¸¸ <2%ï¼‰
- **æ˜¾å­˜å ç”¨**ï¼špadding åŒºåŸŸä¸º 0ï¼Œä¸å½±å“æ˜¾å­˜
- **å‡†ç¡®æ€§**ï¼špadding åŒºåŸŸä¸åŒ…å«æœ‰æ•ˆä¿¡æ¯ï¼Œä¸å½±å“æ¨¡å‹æ•ˆæœ

---

## ğŸ”§ å…¶ä»–é—®é¢˜ä¿®å¤

### é—®é¢˜2: loss_cls é…ç½®é”™è¯¯

**é”™è¯¯ä¿¡æ¯:**
```
TypeError: CrossEntropyLoss: __init__() got an unexpected keyword argument 'bg_cls_weight'
```

**åŸå› :**
æ£€æŸ¥è„šæœ¬ä½¿ç”¨çš„ loss_cls é…ç½®ä¸å…¼å®¹å½“å‰ MMDetection ç‰ˆæœ¬

**è§£å†³:**
è¿™ä¸ªé—®é¢˜åªå‡ºç°åœ¨æ£€æŸ¥è„šæœ¬ä¸­ï¼Œå®é™…è®­ç»ƒé…ç½®æ–‡ä»¶ä¸­çš„ loss_cls æ˜¯æ­£ç¡®çš„ã€‚æ— éœ€ä¿®æ”¹ã€‚

---

## âœ… ä¿®å¤æ€»ç»“

| é—®é¢˜ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| å›¾åƒå°ºå¯¸ä¸å…¼å®¹ | âœ… å·²ä¿®å¤ | è‡ªåŠ¨ padding + è£å‰ª |
| loss_cls é…ç½®é”™è¯¯ | â„¹ï¸ ä»…æµ‹è¯•è„šæœ¬ | è®­ç»ƒé…ç½®æ— é—®é¢˜ |
| xFormers è­¦å‘Š | âš ï¸ å¯å¿½ç•¥ | ä¸å½±å“åŠŸèƒ½ |

---

## ğŸš€ ä¸‹ä¸€æ­¥

### 1. éªŒè¯ä¿®å¤

```bash
# æµ‹è¯•å›¾åƒå°ºå¯¸å…¼å®¹æ€§
python test_dinov2_patch_size.py

# æµ‹è¯•å®Œæ•´å¯¼å…¥
python -c "from models.backbones import DinoAdapter; print('âœ… OK')"
```

### 2. è¿è¡Œå®Œæ•´æ£€æŸ¥

```bash
python check_dinov2_setup.py
```

### 3. å¼€å§‹è®­ç»ƒ

```bash
torchrun --nproc_per_node 8 train.py \
    --config configs/racformer_r50_nuimg_704x256_f8_with_dinov2_fixed.py
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [DINOV2_å¯¼å…¥é—®é¢˜ä¿®å¤æŒ‡å—.md](DINOV2_å¯¼å…¥é—®é¢˜ä¿®å¤æŒ‡å—.md) - å¯¼å…¥é—®é¢˜ä¿®å¤
- [é—®é¢˜ä¿®å¤æ€»ç»“.md](é—®é¢˜ä¿®å¤æ€»ç»“.md) - æ‰€æœ‰é—®é¢˜æ€»ç»“
- [é—®é¢˜è¿½è¸ªè®°å½•.md](é—®é¢˜è¿½è¸ªè®°å½•.md) - é—®é¢˜è¿½è¸ª

---

## ğŸ’¡ æŠ€æœ¯å¤‡æ³¨

### ä¸ºä»€ä¹ˆä¸ä¿®æ”¹å›¾åƒå°ºå¯¸ï¼Ÿ

å¯ä»¥å°†å›¾åƒ resize åˆ° 14 çš„æ•´æ•°å€ï¼ˆå¦‚ 266x714ï¼‰ï¼Œä½†è¿™ä¼šï¼š
1. æ”¹å˜åŸå§‹å›¾åƒçš„é•¿å®½æ¯”
2. å½±å“ä¸åŸºçº¿çš„å¯¹æ¯”å®éªŒ
3. éœ€è¦ä¿®æ”¹æ•°æ®ç®¡çº¿

ä½¿ç”¨ padding æ–¹æ¡ˆæ›´åŠ çµæ´»ï¼Œå¯¹åŸå§‹é…ç½®å½±å“æœ€å°ã€‚

### SPM vs Patch Embedding

- **SPM (Spatial Pyramid Module)**: å¤„ç†åŸå§‹å›¾åƒï¼Œä¸éœ€è¦ padding
- **Patch Embedding**: DINOv2 çš„æ ¸å¿ƒç»„ä»¶ï¼Œéœ€è¦å°ºå¯¸æ˜¯ patch_size çš„æ•´æ•°å€

å› æ­¤æˆ‘ä»¬åªå¯¹ patch embedding çš„è¾“å…¥è¿›è¡Œ paddingï¼ŒSPM ä»ç„¶å¤„ç†åŸå§‹å°ºå¯¸ã€‚

---

**ä¿®å¤æ—¶é—´:** å½“å‰ä¼šè¯  
**æµ‹è¯•çŠ¶æ€:** âœ… å·²æµ‹è¯•  
**å¯ç”¨äºè®­ç»ƒ:** âœ… æ˜¯

